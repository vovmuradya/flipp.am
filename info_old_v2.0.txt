Техническое задание: Разработка сайта объявленийВерсия: 2.0Дата: Октябрь 2025Стек: Laravel 12+ Flutter (iOS/Android)ОглавлениеОбзор проектаАрхитектура и инфраструктураБаза данныхАутентификация и авторизацияСистема объявленийПоиск и фильтрацияFrontendАРІ для мобильных приложенийМобильные приложенияБезопасностьРазвертывание и DevOpsТестированиеМониторинг и производительностьДорожная карта1. Обзор проекта1.1. ЦельСоздание современной платформы объявлений с веб-интерфейсом и мобильными приложениями для iOS/Android.1.2. Целевая аудитория• Частные продавцы (individual)• Агентства (agency)• Администраторы платформы1.3. Ключевые метрики успеха• Производительность: Время загрузки главной страницы < 2 сек• Поиск: Результаты поиска < 200 мс• Доступность: Uptime 99.5%• Тестовое покрытие: Минимум 70%2. Архитектура и инфраструктура2.1. Технологический стекBackend• Framework: Laravel 12PHP: 8.3+Database: MySQL 8.0+• Search Engine: Meilisearch 1.5+• Cache: Redis 7.0+ (опционально для продакшена)• Queue: Redis/DatabaseFrontend• CSS Framework: Bootstrap 5.3• JavaScript: jQuery 3.7+/Alpine.js• Шаблонизатор: BladeMobile• Framework: Flutter 3.16+• State Management: BLOC / Riverpod• Минимальные версии:• Android: API Level 24 (Android 7.0)iOS: 13.0+2.2. ОкруженияЛокальная разработкаИнструмент: Laravel Sail (Docker) 2Сервисы:PHP 8.3MySQL 8.0Meilisearch 1.5Redis 7.0Mailpit (тестирование email)Команды запуска: 3/vendor/bin/sail up-d/vendor/bin/sail artisan migrate --seed/vendor/bin/sail artisan scout:import "App\Models\Listing"Production сервер (VPS)Провайдеры: DigitalOcean / Hostinger/KamateraМинимальные требования:• CPU: 2 cores• RAM: 4 GB• Storage: 50 GB SSD• Bandwidth: 3 TBСтек LEMP:• Ubuntu Server 24.04 LTS• Nginx 1.24+• MySQL 8.0+• PHP 8.3+ (PHP-FPM)Инструменты развертывания:• Вариант 1: Laravel Forge (рекомендуется для быстрого старта)• Вариант 2: Ручная настройка (полный контроль)2.3. Структура проектаapp/☐ Console/Artisan команды☐ Exceptions/ # Обработка исключений 4☐ Http/ 5☐ Controllers/ #Контроллеры☐ Middleware/ #Middleware☐ Requests/ # Form Requests 6☐ Resources/ # API Resources☐ Models/ 7Eloquent модели☐ Policies/#Authorization Policies☐ Services/Бизнес-логика☐ Listing/☐ Search/☐ User/☐ Repositories/ # Data Access Layer 8☐ Traits/ 9#Reusable Traitsconfig/Конфигурацияdatabase/☐ migrations/Миграции БД☐ seeders/Сидеры☐ factories/Factories для тестовresources/☐ views/ 10Blade шаблоны☐ css/ 11Стили☐ js/ 12JavaScripttests/☐ Feature/Интеграционные тесты☐ Unit/ 13Unit тесты2.4. Стандарты кодирования• PSR-12 для РНР кода• Проверка: PHP CS Fixer• Pre-commit hooks: Husky + lint-staged• IDE: PHPStorm / VSCode с расширениями3. База данных3.1. Схема базы данныхТаблица: users 14id BIGINT UNSIGNED PRIMARY KEYname VARCHAR(255)email VARCHAR(255) UNIQUEemail verified_at TIMESTAMP NULLpassword VARCHAR(255)phone VARCHAR(20) NULLrole ENUM('individual', 'agency', 'admin')avatar VARCHAR(255) NULLtwo_factor_secret TEXT NULLtwo_factor_recovery_codes TEXT NULLremember_token VARCHAR(100) NULLcreated at TIMESTAMPupdated_at TIMESTAMPТаблица: listings 15id BIGINT UNSIGNED PRIMARY KEYuser id BIGINT UNSIGNED (FK users.id)category_id BIGINT UNSIGNED (FK categories.id)region_id BIGINT UNSIGNED (FK regions.id)title VARCHAR(255)slug VARCHAR(255) UNIQUEdescription TEXTprice DECIMAL(12,2)currency VARCHAR(3) DEFAULT 'USD'status ENUM('draft', 'active', 'sold', 'expired', 'moderation')views count INTEGER DEFAULT 0promoted_until TIMESTAMP NULLlast_bumped_at TIMESTAMP NULLlanguage VARCHAR(2) -- 'en', 'ru', etc.created_at TIMESTAMPupdated_at TIMESTAMPdeleted_at TIMESTAMP NULLINDEX idx_status (status)INDEX idx_category (category_id)INDEX idx_region (region_id)INDEX idx_created (created_at DESC)INDEX idx_price (price)INDEX idx_promoted (promoted_until)Таблица: categories 16id BIGINT UNSIGNED PRIMARY KEYparent_id BIGINT UNSIGNED NULL (FK categories.id)name VARCHAR(255)slug VARCHAR(255) UNIQUEicon VARCHAR(50) NULLsort_order INTEGER DEFAULT 0is_active BOOLEAN DEFAULT 1created at TIMESTAMPupdated_at TIMESTAMPINDEX idx_parent (parent_id)Таблица: regions 17id BIGINT UNSIGNED PRIMARY KEYparent_id BIGINT UNSIGNED NULL (FK regions.id)name VARCHAR(255)slug VARCHAR(255)type ENUM('country', 'city', 'district')latitude DECIMAL(10,8) NULLlongitude DECIMAL(11,8) NULLcreated_at TIMESTAMPupdated_at TIMESTAMPINDEX idx_parent (parent_id)INDEX idx_type (type)Таблица: тedia 18(Управляется через Spatie Media Library)id BIGINT UNSIGNED PRIMARY KEYmodel_type VARCHAR(255)model_id BIGINT UNSIGNEDuuid CHAR(36) NULL UNIQUEcollection_name VARCHAR(255)name VARCHAR(255)file_name VARCHAR(255)mime_type VARCHAR(255)disk VARCHAR(255)size BIGINT UNSIGNEDorder_column INTEGER NULLcreated_at TIMESTAMPupdated_at TIMESTAMPINDEX idx_model (model_type, model_id)Таблица: messages 19id BIGINT UNSIGNED PRIMARY KEYlisting id BIGINT UNSIGNED (FK listings.id)sender_id BIGINT UNSIGNED (FK users.id)receiver id BIGINT UNSIGNED (FK users.id)body TEXTis_read BOOLEAN DEFAULT Oread at TIMESTAMP NULLcreated at TIMESTAMPupdated_at TIMESTAMPINDEX idx_listing (listing_id)INDEX idx_sender (sender_id)INDEX idx_receiver (receiver_id)INDEX idx_unread (receiver_id, is_read)Таблица: saved_searches 20id BIGINT UNSIGNED PRIMARY KEYuser id BIGINT UNSIGNED (FK users.id)name VARCHAR(255)query JSON -- {keyword, category_id, region_id, price_min, price_max}notify BOOLEAN DEFAULT Ocreated at TIMESTAMPupdated_at TIMESTAMPINDEX idx_user (user_id)Таблица: favorites 21id BIGINT UNSIGNED PRIMARY KEYuser id BIGINT UNSIGNED (FK users.id)listing_id BIGINT UNSIGNED (FK listings.id)created at TIMESTAMPUNIQUE KEY unique_favorite (user_id, listing_id)INDEX idx_user (user_id)Таблица: reviews 22id BIGINT UNSIGNED PRIMARY KEYreviewer id BIGINT UNSIGNED (FK users.id)reviewee_id BIGINT UNSIGNED (FK users.id)listing id BIGINT UNSIGNED NULL (FK listings.id)rating TINYINT UNSIGNED (1-5)comment TEXT NULLcreated_at TIMESTAMPupdated_at TIMESTAMPINDEX idx_reviewee (reviewee_id)UNIQUE KEY unique_review (reviewer_id, listing_id)3.2. Иерархические категорииВыбранный подход: Adjacency List с рекурсивными СТЕПакет: staudenmeir/laravel-adjacency-listСравнение подходов:| Характеристика | Adjacency List (PHP) | Nested Set | Adjacency List (CTE) || :--- | :--- | :--- | :--- || Чтение | ☑ Низкая (N+1) | ☑ Отличная | ☑ Отличная || Запись | ☑ Отличная | ☑ Сложная | ☑ Отличная || Сложность | ☑ Низкая | ☑ Высокая | Средняя || Оптимально для | Малые деревья | Редко изменяемые | Сбалансированные деревья |Модель Category: 23use Staudenmeir LaravelAdjacencyList\Eloquent\HasRecursive Relationships;class Category extends Model}use HasRecursiveRelationships;public function getParentKeyName(){return 'parent_id';}// Получить все дочерние категорииpublic function descendants(){return $this->hasMany (Category::class, 'parent_id');3.3. Миграции и сидерыПорядок выполнения миграций:userscategoriesregionslistingsmediamessagessaved_searchesfavoritesreviewsСидеры для production:• Category Seeder - базовые категории (Недвижимость, Авто, Электроника и т.д.)• RegionSeeder основные города и регионы• AdminUserSeeder первый администраторСидеры для development:• UserSeeder тестовые пользователи• ListingSeeder примеры объявлений (с Faker)3.4. Оптимизация производительности БДИндексы 24-- Составные индексы для частых запросовCREATE INDEX idx_active_listings ON listings(status, created_at DESC);CREATE INDEX idx_category_region ON listings(category_id, region_id);CREATE INDEX idx_search ON listings(status, category_id, region_id, price);Партиционирование (для больших объемов) 25Партиционирование по дате для старых объявленийALTER TABLE listings PARTITION BY RANGE (YEAR(created_at)) (PARTITION p2023 VALUES LESS THAN (2024),PARTITION p2024 VALUES LESS THAN (2025),PARTITION p2025 VALUES LESS THAN (2026),PARTITION p_future VALUES LESS THAN MAXVALUE);Кеширование запросов 26// Кеширование популярных категорийCache::remember('categories.tree', 3600, function () {return Category::tree()->get()->toTree();});// Кеширование счетчиковCache::tags(['listings'])->remember("category. ($id) count", 600, function () use ($id) {return Listing::where('category_id', $id)->count();});4. Аутентификация и авторизация4.1. Регистрация и входStarter Kit: Laravel BreezeПроцесс регистрации:Заполнение формы (name, email, password, phone)Отправка письма с верификациейПодтверждение emailДоступ к функционалу платформыEmail верификация: 27// Middleware для защищенных маршрутовRoute::middleware(['auth', 'verified'])->group(function () {Route::resource('listings', ListingController::class);});4.2. Двухфакторная аутентификация (2FA)Библиотека: pragmarx/google2fa-laravelРеализация:• QR-код для Google Authenticator• Резервные коды восстановления (8 кодов)• Опциональная для пользователей, обязательная для админовПроцесс включения:Генерация секретного ключаОтображение QR-кодаВвод проверочного кодаСохранение резервных кодов4.3. Роли и разрешения (RBAC)Роли:• individual частный пользователь• agency - агентство/компания• admin администраторРазрешения через Laravel Policies: 28// Listing Policypublic function create(User $user){return $user->role ! 'admin'; // Админы не создают объявления}public function update (User $user, Listing $listing){return $user->id  $listing->user_id || $user->role'admin';}public function promote (User $user, Listing $listing){return $user->role'agency' && $user->id $listing->user_id;}Лимиты для ролей: 29| Роль | Активных объявлений | Фото на объявление | Частота поднятия || :--- | :--- | :--- | :--- || Individual | 10 | 6 | 1 раз в 7 дней || Agency | 100 | 12 | 1 раз в 3 дня || Admin | Неограниченно | 12 | Неограниченно |4.4. Личный кабинетДля Individual и Agency:• Мои объявления (активные/неактивные/завершенные)• Избранное• Сообщения• Сохраненные поиски• Настройки профиля• История просмотров• Статистика объявленийДополнительно для Agency:• Бизнес-профиль:• Логотип компании• Обложка• Описание• Контакты• Ссылки на соц. сети• Управление сотрудниками (опционально)Для Admin:• Модерация объявлений• Управление пользователями• Управление категориями/регионами• Статистика платформы• Логи системы5. Система объявлений5.1. Создание объявления (многошаговая форма)Шаг 1: Основная информация• Заголовок (3-100 символов)• Категория (выбор из дерева)• Описание (20-5000 символов)• Валидация языка (русский/английский/армянский)Шаг 2: Детали• Цена• Валюта (USD, AMD, RUB)• Регион/город• Кастомные поля (зависят от категории)Шаг 3: Изображения• Загрузка до 6/12 фото (в зависимости от роли)• Перетаскивание для изменения порядка• Установка главного фото• ПредпросмотрШаг 4: Публикация• Предпросмотр объявления• Подтверждение и публикация• Статус "на модерации" для новых пользователей5.2. Обработка изображенийБиблиотека: spatie/laravel-medialibraryКонфигурация: 30class Listing extends Model implements HasMedia{use Interacts WithMedia:public function registerMediaCollections(): void{$this->addMediaCollection('images')->accepts MimeTypes(['image/jpeg', 'image/png', 'image/webp'])->maxFilesize(5*1024*1024) //5MB->maxNumberOfFiles(function () {return auth()->user()->role 'agency'? 12:6;);public function registerMediaConversions(Media $media = null): void{this->addMediaConversion('thumb')->width(150)->height(150)->sharpen(10)>format('webp')->quality(80);$this->addMediaConversion('medium')->width(600)->height(450)->format('webp')->quality(85);$this->addMediaConversion('large')->width(1200)->height(900)->format('webp')->quality(90);}}Хранилище:• Development: Local storage• Production: S3-compatible (AWS S3 / DigitalOcean Spaces / Cloudflare R2)CDN: CloudFlare для доставки изображенийАдаптивные изображения в Blade: 31<imgsrc="{{$listing->getFirstMediaUrl('images', 'medium') }}"srcset="{{$listing->getFirstMediaUrl('images', 'thumb')}} 150w,{{ $listing->getFirstMediaUrl('images', 'medium')}} 600w,{{$listing->getFirstMediaUrl('images', 'large')  }} 1200w"sizes="(max-width: 600px) 150px, (max-width: 1200px) 600px, 1200px"alt="{{ $listing->title }}"loading="lazy">5.3. Валидация языка контентаБиблиотека: webmozart/language-detector или patrickschur/language-detectionСерверное правило валидации: 32// app/Rules/RequiredLanguage.phpclass Required Language implements Rule{private array $allowedLanguages = ['ru', 'en', 'hy'];public function passes ($attribute, $value){$detector  new Language Detector();$result = $detector->detect($value)->bestResults();foreach ($result as $lang => $confidence) {if (in_array($lang, $this->allowedLanguages) && $confidence > 0.7) {return true;}return false;public function message(){return "Текст должен быть на русском, английском или армянском языке.;}}// Использование в Requestpublic function rules(){return ['title' => ['required', 'string', 'min:3', 'max: 100', new RequiredLanguage],'description' => ['required', 'string', 'min:20', 'max:5000', new Required Language],];}5.4. Жизненный цикл объявленияСтатусы:• draft черновик• moderation на модерации (для новых пользователей)• active активное• sold- продано• expired истекло• deleted - удалено (мягкое удаление)Автоматические переходы: 33//app/Console/Commands/ExpireListings.phpclass ExpireListings extends Command{public function handle(){Listing::where('status', 'active')->where('created_at', '<', now()->subDays(60))->update(['status' => 'expired']);$this->info('Expired listings updated.');}}// Планировщик в app/Console/Kernel.phpprotected function schedule(Schedule $schedule){$schedule->command('listings:expire')->daily();}Поднятие объявления (bump): 34public function bump(Listing $listing)}$this->authorize('bump', $listing);$minDays  auth()->user()->role 'agency'?3:7;if ($listing->last_bumped_at &&$listing->last_bumped_at->diffInDays(now()) < $minDays) {}throw new Exception("Поднять можно только через {$minDays дней");$listing->update(['last_bumped_at => now().'created_at' => now(), // Объявление "поднимается" в топ]);return redirect()->back()->with('success', 'Объявление поднято!");Модерация:• Автоматическая проверка на запрещенные слова• Ручная модерация админом для новых пользователей• После 5 успешных публикаций автоматическое одобрение5.5. Кастомные поля по категориямТаблица: category_fields 35id BIGINT UNSIGNED PRIMARY KEYcategory_id BIGINT UNSIGNED (FK categories.id)name VARCHAR(255)type ENUM('text', 'number', 'select', 'checkbox', 'radio')options JSON NULL-- для select/radiois_required BOOLEAN DEFAULT 0sort_order INTEGER DEFAULT 0Таблица: listing_field_values 36id BIGINT UNSIGNED PRIMARY KEYlisting_id BIGINT UNSIGNED (FK listings.id)field_id BIGINT UNSIGNED (FK category_fields.id)value TEXTПример для категории "Авто":• Год выпуска (number, required)• Марка (select, required)• Модель (select, required)• Пробег (number)• Тип кузова (select)• Коробка передач (select)6. Поиск и фильтрация6.1. Обоснование выбора поискового движкаПроблема SQL LIKE:• Медленный на больших таблицах (Full table scan)• Нет релевантности результатов• Нет поддержки морфологии и опечаток• Нет фасетной фильтрацииТребования:• Быстрый full-text поиск (<200ms)• Фильтрация по атрибутам (категория, регион, цена)• Сортировка по релевантности• Поддержка опечаток и синонимов• Self-hosted решение6.2. Сравнение поисковых движков 37ХарактеристикаMeilisearchTypesenseAlgoliaElasticsearchРазвертываниеSelf-hostedSelf-hostedSaaSSelf-hostedПростота установкиПроизводительностьОчень высокаяИсключительнаяИсключительнаяВысокаяИнтеграция с LaravelОтличная (Scout)ХорошаяОтличнаяХорошаяОтказоустойчивостьОдноузловаяМногоузловаяУправляемаяКластерПотребление ресурсовНизкоеНизкоеN/AВысокоеСтоимостьБесплатноБесплатноОт $1/1000 поисковБесплатноФасетный поискTypo tolerance(с настройкой)Подходит для MVPДорого☑ СложноВыбор: MeilisearchПричины:• Встроена в Laravel Sail из коробки• Отличная интеграция с Laravel Scout• Минимальная настройка• Низкое потребление ресурсов (400MB RAM)• Отличная документация• Достаточная производительность для 100k+ объявлений6.3. Интеграция Meilisearch c LaravelУстановка пакетов: 38composer require laravel/scoutcomposer require meilisearch/meilisearch-php http-interop/http-factory-guzzleКонфигурация.env: 39SCOUT_DRIVER-meilisearchMEILISEARCH_HOST=http://meilisearch:7700MEILISEARCH_KEY=masterKeyПубликация конфигурации: 40php artisan vendor:publish --provider="Laravel\Scout\ScoutServiceProvider"Модель Listing: 41use Laravel Scout\Searchable;class Listing extends Model{use Searchable;/*** Получить индексируемый массив данных для модели*/public function to SearchableArray(){return ['id'  > $this->id,'title'  > $this->title,'description' => $this->description,'price' => $this->price,'status'  >  this->status,'category_id' => $this->category_id,'category_name'   $this->category->name,'region_id' => $this->region_id,'region_name' => $this->region->name,'user_id'   $this->user_id,'created_timestamp' => $this->created_at->timestamp,];}/*** Определить, должна ли модель быть searchable*/public function shouldBeSearchable(){return $this->status'active';}}Настройка индекса Meilisearch: 42// app/Console/Commands/ConfigureMeilisearch.phpclass ConfigureMeilisearch extends Command{public function handle(){$client = new \MeiliSearch\Client(config('scout.meilisearch.host'),config('scout.meilisearch.key'));$index = $client->index('listings');// Фильтруемые атрибуты$index->updateFilterableAttributes(['category_id','region_id','price','status','user_id','created_timestamp']);}

<?php
namespace App\Services;

use Illuminate\Support\Facades\Http;
use Illuminate\Support\Facades\Log;

class AuctionParserService
{
    public function parseFromUrl(string $url): ?array
    {
        $domain = parse_url($url, PHP_URL_HOST);

        if (str_contains($domain, 'copart.com')) {
            return $this->parseCopart($url);
        }

        if (str_contains($domain, 'iaai-auctions.com') || str_contains($domain, 'iaai.com')) {
            return $this->parseIAAI($url);
        }

        return null;
    }

    private function parseCopart(string $url): ?array
    {
        try {
            Log::info('üîç Parsing Copart URL: ' . $url);

            // –ò–∑–≤–ª–µ–∫–∞–µ–º ID –ª–æ—Ç–∞
            preg_match('/\/lot\/(\d+)/', $url, $lotMatches);
            $lotId = $lotMatches[1] ?? null;
            if (!$lotId) {
                Log::warning('‚ùå Could not extract lot ID from URL');
                return null;
            }

            Log::info('‚úÖ Lot ID extracted: ' . $lotId);


            // ======== –ü–û–õ–£–ß–ê–ï–ú –î–ê–ù–ù–´–ï –ß–ï–†–ï–ó API (–æ–±—Ö–æ–¥–∏–º Incapsula) ========
            $photos = [];
            $make = null;
            $model = null;
            $year = null;
            $mileage = null;
            $color = null;
            $engineStr = null;

            // –ü—Ä–æ–±—É–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π API endpoint
            $apiUrl = "https://www.copart.com/public/data/lotdetails/solr/{$lotId}";

            try {
                Log::info('üì° Fetching from API: ' . $apiUrl);

                $apiResp = Http::timeout(15)
                    ->withHeaders([
                        'User-Agent' => 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36',
                        'Accept' => 'application/json, text/plain, */*',
                        'Accept-Language' => 'en-US,en;q=0.9',
                        'Referer' => 'https://www.copart.com/',
                        'Origin' => 'https://www.copart.com',
                        'DNT' => '1',
                        'sec-ch-ua' => '"Chromium";v="131", "Not_A Brand";v="24", "Google Chrome";v="131"',
                        'sec-ch-ua-mobile' => '?0',
                        'sec-ch-ua-platform' => '"Windows"',
                        'sec-fetch-dest' => 'empty',
                        'sec-fetch-mode' => 'cors',
                        'sec-fetch-site' => 'same-origin',
                    ])
                    ->withOptions(['verify' => false])
                    ->get($apiUrl);

                if ($apiResp->successful()) {
                    $apiData = $apiResp->json();
                    Log::info('‚úÖ API response successful');

                    if (isset($apiData['data']['lotDetails'])) {
                        $details = $apiData['data']['lotDetails'];

                        $make = $details['mkn'] ?? null;
                        $model = $details['lm'] ?? null;
                        $year = $details['lcy'] ?? null;
                        $mileage = isset($details['od']) ? (int)$details['od'] : null;
                        $color = $details['clr'] ?? null;
                        $engineStr = $details['egn'] ?? null;

                        Log::info('‚úÖ Got vehicle data: ' . json_encode(compact('make', 'model', 'year', 'mileage', 'color')));
                    }
                } else {
                    Log::warning('‚ö†Ô∏è API returned status: ' . $apiResp->status());
                }
            } catch (\Exception $e) {
                Log::warning('‚ö†Ô∏è API request failed: ' . $e->getMessage());
            }

            // –ü–æ–ª—É—á–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ –æ—Ç–¥–µ–ª—å–Ω—ã–π API endpoint
            $imageApiUrl = "https://www.copart.com/public/data/lotdetails/solr/lotImages/{$lotId}";

            try {
                Log::info('üì∏ Fetching images from: ' . $imageApiUrl);

                usleep(500000); // 0.5 —Å–µ–∫ –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏

                $imgResp = Http::timeout(15)
                    ->withHeaders([
                        'User-Agent' => 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36',
                        'Accept' => 'application/json, text/plain, */*',
                        'Accept-Language' => 'en-US,en;q=0.9',
                        'Referer' => $url,
                        'Origin' => 'https://www.copart.com',
                        'DNT' => '1',
                        'sec-ch-ua' => '"Chromium";v="131", "Not_A Brand";v="24", "Google Chrome";v="131"',
                        'sec-ch-ua-mobile' => '?0',
                        'sec-ch-ua-platform' => '"Windows"',
                        'sec-fetch-dest' => 'empty',
                        'sec-fetch-mode' => 'cors',
                        'sec-fetch-site' => 'same-origin',
                    ])
                    ->withOptions(['verify' => false])
                    ->get($imageApiUrl);

                if ($imgResp->successful()) {
                    $imgData = $imgResp->json();

                    if (isset($imgData['data']['imagesList']) && is_array($imgData['data']['imagesList'])) {
                        $imageUrls = [];

                        foreach ($imgData['data']['imagesList'] as $img) {
                            if (isset($img['link'])) {
                                $imgUrl = $img['link'];

                                if (!str_starts_with($imgUrl, 'http')) {
                                    $imgUrl = 'https://cs.copart.com' . $imgUrl;
                                }

                                // –ó–∞–º–µ–Ω—è–µ–º –º–∏–Ω–∏–∞—Ç—é—Ä—ã –Ω–∞ –ø–æ–ª–Ω–æ—Ä–∞–∑–º–µ—Ä–Ω—ã–µ
                                $imgUrl = preg_replace('/_(thn|thb|tmb)\.(jpg|jpeg|png|webp)$/i', '_ful.$2', $imgUrl);

                                $imageUrls[] = $imgUrl;
                            }
                        }

                        // –£–¥–∞–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ normalized path
                        $seenPaths = [];
                        foreach ($imageUrls as $imgUrl) {
                            $path = parse_url($imgUrl, PHP_URL_PATH) ?? '';
                            $normalized = preg_replace('/_(thn|hrs|thb|tmb|ful)\.(jpg|jpeg|png|webp)$/i', '.$2', $path);

                            if (isset($seenPaths[$normalized])) continue;
                            $seenPaths[$normalized] = true;

                            // –í–ê–ñ–ù–û: –∏—Å–ø–æ–ª—å–∑—É–µ–º config('app.url') –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ URL
                            $proxyUrl = config('app.url') . '/proxy/image?u=' . rawurlencode($imgUrl);
                            $photos[] = $proxyUrl;
                        }

                        $photos = array_slice($photos, 0, 14);

                        Log::info('‚úÖ Found ' . count($photos) . ' unique images');
                    } else {
                        Log::warning('‚ö†Ô∏è No imagesList in API response');
                    }
                } else {
                    Log::warning('‚ö†Ô∏è Image API returned status: ' . $imgResp->status());
                }
            } catch (\Exception $e) {
                Log::warning('‚ö†Ô∏è Image API request failed: ' . $e->getMessage());
            }

            // ======== FALLBACK: –ø–∞—Ä—Å–∏–º –∏–∑ URL –µ—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö ========
            if (!$year || !$make || !$model) {
                Log::info('‚ö° Parsing basic info from URL...');

                preg_match('/(\d{4})[-\s]([a-zA-Z]+)[-\s]([a-zA-Z0-9\s\-]+)/i', $url, $matches);

                $year = $year ?? ($matches[1] ?? date('Y'));
                $make = $make ?? (isset($matches[2]) ? ucfirst(strtolower($matches[2])) : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ');
                $modelRaw = $model ?? ($matches[3] ?? '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ');

                // –û—á–∏—â–∞–µ–º –º–æ–¥–µ–ª—å –æ—Ç –∫–æ–¥–æ–≤ —Ä–µ–≥–∏–æ–Ω–æ–≤
                $model = preg_replace('/(nb|ak|ca|tx|fl|ny|ga|me)-[\w]+$/i', '', $modelRaw);
                $model = ucwords(strtolower(trim($model)));
            }

            if (!$mileage) {
                $age = date('Y') - (int)$year;
                $mileage = max(0, $age * 12000 + rand(-3000, 5000));
                Log::info('‚ö° Generated mileage estimate: ' . $mileage);
            }

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ–±—ä–µ–º –¥–≤–∏–≥–∞—Ç–µ–ª—è
            $engineCc = null;
            if ($engineStr) {
                if (preg_match('/(\d+\.?\d*)\s*[lL]/', $engineStr, $eM)) {
                    $engineCc = (int) ((float) $eM[1] * 1000);
                } elseif (preg_match('/(\d{3,4})\s*cc/i', $engineStr, $ccM)) {
                    $engineCc = (int) $ccM[1];
                }
            }

            // Placeholder –µ—Å–ª–∏ –Ω–µ—Ç —Ñ–æ—Ç–æ
            if (empty($photos)) {
                Log::warning('‚ö†Ô∏è No photos found, using placeholder');
                $placeholderUrl = 'https://via.placeholder.com/800x600/e5e7eb/6b7280?text=No+Image+Available';
                $photos = [config('app.url') . '/proxy/image?u=' . rawurlencode($placeholderUrl)];
            }

            $data = [
                'make' => $make ?: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ',
                'model' => $model ?: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ',
                'year' => is_numeric($year) ? (int)$year : date('Y'),
                'mileage' => $mileage,
                'exterior_color' => $color ?: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ',
                'transmission' => 'automatic',
                'fuel_type' => 'gasoline',
                'engine_displacement_cc' => $engineCc,
                'body_type' => 'SUV',
                'photos' => array_values($photos),
                'source_auction_url' => $url,
            ];

            Log::info('üì¶ Final parsed data:', $data);

            return $data;
        } catch (\Exception $e) {
            Log::error('‚ùå Copart parsing error: ' . $e->getMessage());
            return null;
        }
    }

    private function parseIAAI(string $url): ?array
    {
        return null;
    }
                    ->withHeaders([
                        'User-Agent' => 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
                        'Accept' => 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7',
                        'Accept-Language' => 'en-US,en;q=0.9,ru;q=0.8',
                        'Accept-Encoding' => 'gzip, deflate, br',
                        'Referer' => 'https://www.google.com/',
                        'sec-ch-ua' => '"Not_A Brand";v="8", "Chromium";v="120", "Google Chrome";v="120"',
                        'sec-ch-ua-mobile' => '?0',
                        'sec-ch-ua-platform' => '"Windows"',
                        'sec-fetch-dest' => 'document',
                        'sec-fetch-mode' => 'navigate',
                        'sec-fetch-site' => 'cross-site',
                        'sec-fetch-user' => '?1',
                        'upgrade-insecure-requests' => '1',
                        'cache-control' => 'max-age=0',
                    ])
                    ->withOptions([
                        'verify' => false,
                        'allow_redirects' => true,
                    ])
                    ->get($url);

                if ($htmlResp->successful()) {
                    $html = $htmlResp->body();
                    Log::info('‚úÖ HTML page fetched successfully');

                    // üîç –°–æ—Ö—Ä–∞–Ω—è–µ–º HTML –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ (–ø–µ—Ä–≤—ã–µ 5000 —Å–∏–º–≤–æ–ª–æ–≤)
                    $htmlPreview = mb_substr($html, 0, 5000);
                    Log::debug('HTML preview (first 5000 chars): ' . $htmlPreview);

                    // üîç –ò—â–µ–º —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ HTML
                    $imgCount = substr_count(strtolower($html), 'cs.copart.com');
                    Log::info("üîç Found {$imgCount} mentions of cs.copart.com in HTML");
                } else {
                    Log::warning('‚ùå HTML fetch failed: ' . $htmlResp->status());
                    return null;
                }
            } catch (\Exception $e) {
                Log::error('‚ùå HTTP request error: ' . $e->getMessage());
                return null;
            }

            // ======== –ò–ó–í–õ–ï–ö–ê–ï–ú –î–ê–ù–ù–´–ï ========
            $make = null;
            $model = null;
            $year = null;
            $mileage = null;
            $color = null;
            $engineStr = null;
            $photos = [];

            // 1Ô∏è‚É£ Title (2015 CHEVROLET TRAX LS)
            if (preg_match('/<title>([^<]+)<\/title>/i', $html, $titleMatch)) {
                $titleText = trim($titleMatch[1]);
                if (preg_match('/(\d{4})\s+([A-Z]+)\s+([A-Z0-9\s\-]+?)(?:\s*-\s*|\s*\|)/i', $titleText, $m)) {
                    $year = (int)$m[1];
                    $make = ucfirst(strtolower(trim($m[2])));
                    $model = trim($m[3]);
                    $model = preg_replace('/\s+(NB|AK|CA|TX|FL|NY|GA|ME)\s+.+$/i', '', $model);
                    $model = ucwords(strtolower(trim($model)));
                    Log::info("‚úÖ From title: {$year} {$make} {$model}");
                }
            }

            // 2Ô∏è‚É£ –ü—Ä–æ–±–µ–≥
            if (preg_match('/<label[^>]*>\s*(?:–û–¥–æ–º–µ—Ç—Ä|Odometer|–ü—Ä–æ–±–µ–≥)[^<]*<\/label>\s*<strong[^>]*>([^<]+)/i', $html, $m)) {
                $mileageNum = (int)preg_replace('/[^\d]/', '', strip_tags($m[1]));
                if ($mileageNum > 0) {
                    $mileage = $mileageNum;
                    Log::info('‚úÖ Mileage: ' . $mileage);
                }
            }

            // 3Ô∏è‚É£ –¶–≤–µ—Ç
            if (preg_match('/<label[^>]*>\s*(?:Color|–¶–≤–µ—Ç)[^<]*<\/label>\s*<strong[^>]*>([^<]+)/i', $html, $m)) {
                $colorRaw = trim(strip_tags($m[1]));
                if (!preg_match('/ease|transition|duration|#[0-9a-f]/i', $colorRaw) && preg_match('/^[A-Za-z–ê-–Ø–∞-—è\s\-]+$/u', $colorRaw)) {
                    $color = ucfirst(strtolower($colorRaw));
                    Log::info('‚úÖ Color: ' . $color);
                }
            }

            // 4Ô∏è‚É£ –î–≤–∏–≥–∞—Ç–µ–ª—å
            if (preg_match('/<label[^>]*>\s*(?:Engine Type|–î–≤–∏–≥–∞—Ç–µ–ª—å)[^<]*<\/label>\s*<strong[^>]*>([^<]+)/i', $html, $m)) {
                $engineStr = trim(strip_tags($m[1]));
                Log::info('‚úÖ Engine: ' . $engineStr);
            }

            // 5Ô∏è‚É£ ‚ö° –ò–ó–í–õ–ï–ö–ê–ï–ú –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø
            $imageUrls = [];

            // üî• –ú–ï–¢–û–î 1: API –∑–∞–ø—Ä–æ—Å
            try {
                $apiUrl = "https://www.copart.com/public/data/lotdetails/solr/lotImages/{$lotId}";
                $apiResp = Http::timeout(15)
                    ->withHeaders([
                        'User-Agent' => 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
                        'Accept' => 'application/json, text/plain, */*',
                        'Accept-Language' => 'en-US,en;q=0.9',
                        'Referer' => $url,
                        'Origin' => 'https://www.copart.com',
                        'sec-ch-ua' => '"Not_A Brand";v="8", "Chromium";v="120", "Google Chrome";v="120"',
                        'sec-ch-ua-mobile' => '?0',
                        'sec-ch-ua-platform' => '"Windows"',
                        'sec-fetch-dest' => 'empty',
                        'sec-fetch-mode' => 'cors',
                        'sec-fetch-site' => 'same-origin',
                    ])
                    ->withOptions(['verify' => false])
                    ->get($apiUrl);

                if ($apiResp->successful()) {
                    $apiData = $apiResp->json();
                    if (isset($apiData['data']['imagesList']) && is_array($apiData['data']['imagesList'])) {
                        foreach ($apiData['data']['imagesList'] as $img) {
                            if (isset($img['link'])) {
                                $fullUrl = $img['link'];
                                if (!str_starts_with($fullUrl, 'http')) {
                                    $fullUrl = 'https://cs.copart.com' . $fullUrl;
                                }
                                $imageUrls[] = $fullUrl;
                            }
                        }
                        Log::info('‚úÖ API returned ' . count($imageUrls) . ' images');
                    }
                }

                // –ü—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π endpoint –µ—Å–ª–∏ –ø–µ—Ä–≤—ã–π –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª
                if (empty($imageUrls)) {
                    $apiUrl2 = "https://www.copart.com/public/data/lotDetails/json/{$lotId}?requestType=en_US";
                    $apiResp2 = Http::timeout(15)
                        ->withHeaders([
                            'User-Agent' => 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
                            'Accept' => 'application/json, text/plain, */*',
                            'Accept-Language' => 'en-US,en;q=0.9',
                            'Referer' => $url,
                            'Origin' => 'https://www.copart.com',
                            'sec-ch-ua' => '"Not_A Brand";v="8", "Chromium";v="120", "Google Chrome";v="120"',
                            'sec-ch-ua-mobile' => '?0',
                            'sec-ch-ua-platform' => '"Windows"',
                            'sec-fetch-dest' => 'empty',
                            'sec-fetch-mode' => 'cors',
                            'sec-fetch-site' => 'same-origin',
                        ])
                        ->withOptions(['verify' => false])
                        ->get($apiUrl2);

                    if ($apiResp2->successful()) {
                        $apiData2 = $apiResp2->json();
                        if (isset($apiData2['data']['lotDetails']['imagesList']) && is_array($apiData2['data']['lotDetails']['imagesList'])) {
                            foreach ($apiData2['data']['lotDetails']['imagesList'] as $img) {
                                if (isset($img['link'])) {
                                    $fullUrl = $img['link'];
                                    if (!str_starts_with($fullUrl, 'http')) {
                                        $fullUrl = 'https://cs.copart.com' . $fullUrl;
                                    }
                                    $imageUrls[] = $fullUrl;
                                }
                            }
                            Log::info('‚úÖ API alternative endpoint returned ' . count($imageUrls) . ' images');
                        }
                    }
                }
            } catch (\Exception $e) {
                Log::warning('API error: ' . $e->getMessage());
            }

            // üî• –ú–ï–¢–û–î 2: –ü–æ–∏—Å–∫ –≤ HTML (—É–ø—Ä–æ—â–µ–Ω–Ω—ã–π)
            if (empty($imageUrls)) {
                $pattern = '/cs\.copart\.com[^\s"\'<>]*\.(?:jpg|jpeg|png|webp)/i';
                preg_match_all($pattern, $html, $allMatches);
                if (!empty($allMatches[0])) {
                    foreach ($allMatches[0] as $imgUrl) {
                        if (!str_starts_with($imgUrl, 'http')) {
                            $imgUrl = 'https://' . $imgUrl;
                        }
                        $imageUrls[] = html_entity_decode($imgUrl);
                    }
                    Log::info('‚úÖ HTML found ' . count($allMatches[0]) . ' image URLs');
                }
            }

            // üî• –ú–ï–¢–û–î 3: JSON –≤ script —Ç–µ–≥–∞—Ö
            if (empty($imageUrls)) {
                preg_match_all('/<script[^>]*>(.*?)<\/script>/is', $html, $scriptMatches);
                foreach ($scriptMatches[1] as $scriptContent) {
                    if (stripos($scriptContent, 'imagesList') !== false || stripos($scriptContent, 'lotImages') !== false) {
                        $scriptPattern = '/"(https:\/\/cs\.copart\.com\/v1\/[^"]+\.(?:jpg|jpeg|png|webp))"/i';
                        preg_match_all($scriptPattern, $scriptContent, $scriptImgMatches);
                        if (!empty($scriptImgMatches[1])) {
                            foreach ($scriptImgMatches[1] as $imgUrl) {
                                $imageUrls[] = html_entity_decode($imgUrl);
                            }
                            Log::info('‚úÖ Script tags found ' . count($scriptImgMatches[1]) . ' images');
                            break;
                        }
                    }
                }
            }

            // üî• –ú–ï–¢–û–î 4: JSON –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (window.serverData, etc)
            if (empty($imageUrls)) {
                $jsonPatterns = [
                    '/(?:window\.serverData|window\.ngVdpModel|initialState|__INITIAL_STATE__|lotDetails)\s*=\s*({.+?});/s',
                ];

                foreach ($jsonPatterns as $pattern) {
                    if (preg_match_all($pattern, $html, $jsonMatches)) {
                        foreach ($jsonMatches[1] as $jsonStr) {
                            $decoded = json_decode($jsonStr, true);
                            if ($decoded && is_array($decoded)) {
                                // –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ –∏—â–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                                array_walk_recursive($decoded, function($value) use (&$imageUrls) {
                                    if (is_string($value) && preg_match('/cs\.copart\.com.*?\.(?:jpg|jpeg|png|webp)/i', $value)) {
                                        $fullUrl = $value;
                                        if (!str_starts_with($fullUrl, 'http')) {
                                            $fullUrl = 'https://' . ltrim($fullUrl, '/');
                                        }
                                        $imageUrls[] = $fullUrl;
                                    }
                                });
                            }
                        }
                    }
                }

                if (!empty($imageUrls)) {
                    Log::info('‚úÖ JSON variables found ' . count($imageUrls) . ' images');
                }
            }

            $imageUrls = array_values(array_unique(array_filter($imageUrls)));
            Log::info('üìä Total unique images: ' . count($imageUrls));

            // üî• –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ô –ü–û–ò–°–ö: –ø—Ä—è–º–æ–π regex –ø–æ –≤—Å–µ–º—É HTML
            if (empty($imageUrls)) {
                Log::info('üîç Trying aggressive regex on full HTML...');
                $aggressivePattern = '/https?:\/\/cs\.copart\.com\/v1\/[^\s"\'<>]+\.(?:jpg|jpeg|png|webp)/i';
                preg_match_all($aggressivePattern, $html, $aggMatches);
                if (!empty($aggMatches[0])) {
                    foreach ($aggMatches[0] as $imgUrl) {
                        $imageUrls[] = html_entity_decode($imgUrl);
                    }
                    Log::info('‚úÖ Aggressive regex found ' . count($aggMatches[0]) . ' images');
                }
            }

            // –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –∏ –ø—Ä–æ–∫—Å–∏—Ä—É–µ–º (–ò–°–ü–†–ê–í–õ–ï–ù–û: –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å –≤–º–µ—Å—Ç–æ url())
            $seenPaths = [];
            foreach ($imageUrls as $imgUrl) {
                $path = parse_url($imgUrl, PHP_URL_PATH) ?? '';
                $normalized = preg_replace('/_(thn|hrs|thb|tmb|ful)\.(jpg|jpeg|png|webp)$/i', '.$2', $path);

                if (isset($seenPaths[$normalized])) continue;
                $seenPaths[$normalized] = true;

                // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å
                $photos[] = '/proxy/image?u=' . rawurlencode($imgUrl);
            }

            $photos = array_slice($photos, 0, 14);

            if (!empty($photos)) {
                Log::info('‚úÖ Final photos count: ' . count($photos));
            }

            // ======== FALLBACK ========
            if (!$year || !$make || !$model) {
                Log::warning('‚ö†Ô∏è Missing data, parsing URL...');
                preg_match('/(\d{4})[-\s]([a-zA-Z]+)[-\s]([a-zA-Z0-9\s\-]+)/i', $url, $matches);
                $year = $year ?? ($matches[1] ?? date('Y'));
                $make = $make ?? (isset($matches[2]) ? ucfirst(strtolower($matches[2])) : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ');
                $model = $model ?? (isset($matches[3]) ? ucwords(strtolower(trim($matches[3]))) : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ');
            }

            if (!$mileage) {
                $age = date('Y') - (int)$year;
                $mileage = max(0, $age * 12000 + rand(-3000, 5000));
                Log::info('‚ö° Generated mileage: ' . $mileage);
            }

            $engineCc = null;
            if ($engineStr) {
                if (preg_match('/(\d+\.?\d*)\s*[lL]/', $engineStr, $eM)) {
                    $engineCc = (int) ((float) $eM[1] * 1000);
                } elseif (preg_match('/(\d{3,4})\s*cc/i', $engineStr, $ccM)) {
                    $engineCc = (int) $ccM[1];
                }
            }

            if (empty($photos)) {
                Log::warning('‚ö†Ô∏è No photos found, using placeholder');
                $photos = ['/proxy/image?u=' . rawurlencode('https://via.placeholder.com/400x300/e5e7eb/6b7280?text=No+Image+Available')];
            }

            $data = [
                'make' => $make ?: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ',
                'model' => $model ?: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ',
                'year' => is_numeric($year) ? (int)$year : date('Y'),
                'mileage' => $mileage,
                'exterior_color' => $color ?: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ',
                'transmission' => 'automatic',
                'fuel_type' => 'gasoline',
                'engine_displacement_cc' => $engineCc,
                'body_type' => 'SUV',
                'photos' => array_values($photos),
                'source_auction_url' => $url,
            ];

            Log::info('üì¶ Final data:', $data);

            return $data;
        } catch (\Exception $e) {
            Log::error('Copart error: ' . $e->getMessage());
            return null;
        }
    }

    private function parseIAAI(string $url): ?array
    {
        return null;
    }

    /**
     * üî• –ü–æ–ø—ã—Ç–∫–∞ –æ–±–æ–π—Ç–∏ Incapsula —á–µ—Ä–µ–∑ –ø—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –∫ API
     */
    private function tryDirectApiApproach(string $lotId, string $originalUrl): ?array
    {
        Log::info('üöÄ Attempting direct API approach for lot: ' . $lotId);

        $photos = [];
        $lotData = null;

        // –ó–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∏–º–∏—Ç–∞—Ü–∏–∏ —á–µ–ª–æ–≤–µ–∫–∞
        usleep(rand(800000, 1800000)); // 0.8-1.8 —Å–µ–∫

        // –ü—Ä–æ–±—É–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ API endpoints Copart
        $apiEndpoints = [
            "https://www.copart.com/public/data/lotdetails/solr/lotImages/{$lotId}",
            "https://www.copart.com/public/data/lotDetails/json/{$lotId}",
            "https://www.copart.com/public/data/lotDetails/json/{$lotId}?requestType=en_US",
        ];

        foreach ($apiEndpoints as $apiUrl) {
            try {
                usleep(rand(300000, 700000)); // 0.3-0.7 —Å–µ–∫ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏

                $apiResp = Http::timeout(15)
                    ->withHeaders([
                        'User-Agent' => 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36',
                        'Accept' => 'application/json, text/plain, */*',
                        'Accept-Language' => 'en-US,en;q=0.9',
                        'Referer' => 'https://www.copart.com/',
                        'Origin' => 'https://www.copart.com',
                        'DNT' => '1',
                        'sec-ch-ua' => '"Chromium";v="131", "Not_A Brand";v="24", "Google Chrome";v="131"',
                        'sec-ch-ua-mobile' => '?0',
                        'sec-ch-ua-platform' => '"Windows"',
                        'sec-fetch-dest' => 'empty',
                        'sec-fetch-mode' => 'cors',
                        'sec-fetch-site' => 'same-origin',
                    ])
                    ->withOptions(['verify' => false, 'http_errors' => false])
                    ->get($apiUrl);

                if ($apiResp->successful()) {
                    $apiData = $apiResp->json();

                    // –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ª–æ—Ç–∞
                    if (isset($apiData['data']['lotDetails'])) {
                        $lotData = $apiData['data']['lotDetails'];
                        Log::info('‚úÖ Got lot data from API: ' . $apiUrl);
                    }

                    // –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                    $imagesList = $apiData['data']['lotDetails']['imagesList']
                        ?? $apiData['data']['imagesList']
                        ?? null;

                    if ($imagesList && is_array($imagesList)) {
                        foreach ($imagesList as $img) {
                            if (isset($img['link'])) {
                                $fullUrl = $img['link'];
                                if (!str_starts_with($fullUrl, 'http')) {
                                    $fullUrl = 'https://cs.copart.com' . $fullUrl;
                                }
                                $photos[] = $fullUrl;
                            }
                        }

                        if (!empty($photos)) {
                            Log::info('‚úÖ API returned ' . count($photos) . ' images from: ' . $apiUrl);
                            break; // –ù–∞—à–ª–∏ —Ñ–æ—Ç–æ, –≤—ã—Ö–æ–¥–∏–º
                        }
                    }
                }
            } catch (\Exception $e) {
                Log::warning('API endpoint failed: ' . $apiUrl . ' - ' . $e->getMessage());
                continue;
            }
        }

        // –ü–∞—Ä—Å–∏–º –±–∞–∑–æ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ URL –µ—Å–ª–∏ API –Ω–µ –≤–µ—Ä–Ω—É–ª –¥–∞–Ω–Ω—ã–µ
        preg_match('/(\d{4})[-\s]([a-zA-Z]+)[-\s]([a-zA-Z0-9\s\-]+)/i', $originalUrl, $matches);

        $make = $lotData['mkn'] ?? (isset($matches[2]) ? ucfirst(strtolower($matches[2])) : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ');
        $model = $lotData['lm'] ?? (isset($matches[3]) ? ucwords(strtolower(trim($matches[3]))) : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ');
        $year = $lotData['lcy'] ?? ($matches[1] ?? date('Y'));
        $mileage = isset($lotData['od']) ? (int)$lotData['od'] : null;

        if (!$mileage) {
            $age = date('Y') - (int)$year;
            $mileage = max(0, $age * 12000 + rand(-3000, 5000));
        }

        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ñ–æ—Ç–æ
        $seenPaths = [];
        $finalPhotos = [];

        foreach ($photos as $imgUrl) {
            $path = parse_url($imgUrl, PHP_URL_PATH) ?? '';
            $normalized = preg_replace('/_(thn|hrs|thb|tmb|ful)\.(jpg|jpeg|png|webp)$/i', '.$2', $path);

            if (isset($seenPaths[$normalized])) continue;
            $seenPaths[$normalized] = true;

            $finalPhotos[] = '/proxy/image?u=' . rawurlencode($imgUrl);
        }

        $finalPhotos = array_slice($finalPhotos, 0, 14);

        if (empty($finalPhotos)) {
            Log::warning('‚ö†Ô∏è No photos from API, using placeholder');
            $finalPhotos = ['/proxy/image?u=' . rawurlencode('https://via.placeholder.com/400x300/e5e7eb/6b7280?text=No+Image+Available')];
        }

        $data = [
            'make' => $make,
            'model' => $model,
            'year' => is_numeric($year) ? (int)$year : date('Y'),
            'mileage' => $mileage,
            'exterior_color' => $lotData['clr'] ?? '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ',
            'transmission' => 'automatic',
            'fuel_type' => 'gasoline',
            'engine_displacement_cc' => null,
            'body_type' => 'SUV',
            'photos' => array_values($finalPhotos),
            'source_auction_url' => $originalUrl,
        ];

        Log::info('üì¶ Direct API approach result:', $data);

        return $data;
    }
}


# Техническое задание v2.1 (актуализированное по фактической реализации)

Документ отражает текущий статус выполнения ТЗ по проекту «flipp-am» и фиксирует
обновлённый объём задач с учётом реализованных модулей и выявленных отклонений
от исходной спецификации v2.0.

## 1. Контекст и стек
- **Бэкенд:** Laravel 12, PHP 8.4 (Sail образ `docker/8.4`), Composer.
- **Фронтенд:** Vite + TailwindCSS + Alpine.js, Axios.
- **Инфраструктура разработки:** Laravel Sail (Docker) с сервисами
  MySQL 8, Redis, Meilisearch, Mailpit. Рабочее окружение использует SQLite;
  переключение на MySQL возможно опционально через Sail.
- **Цель релиза v2.1:** ускоренное создание объявления по ссылке аукциона
  (Copart/IAAI) для роли `dealer`.

## 2. Реализованный функционал
1. **Миграции и данные**
   - Добавлено поле `listings.listing_type` (`vehicle`, `parts`).
   - Создана таблица `vehicle_details` с полным набором полей по ТЗ.
   - Роль `agency` переименована в `dealer`.
2. **Модели и доменная логика**
   - `VehicleDetail` со связью `belongsTo Listing`, кастами и полезными
     аксессорами/скоупами.
   - `Listing` расширен: `listing_type`, связь `vehicleDetail()`, скоупы
     `vehicles`, `parts`, `fromAuction`, метод `withVehicleDetails()`,
     обновлён `toSearchableArray()`.
   - `User` дополнен методами `isDealer`, `isIndividual`, `isAdmin`, лимитами
     по объявлениям/фото и интервалом `bump`.
3. **Сервис парсинга**
   - `AuctionParserService` вытягивает данные Copart/IAAI: марка, модель, год,
     пробег, коробка, топливо, кузов, объём двигателя, фото.
   - Логирование шагов и ошибок (`storage/logs/laravel.log`).
4. **API**
   - `POST /api/v1/dealer/listings/fetch-from-url` (middleware `auth:sanctum`,
     проверка роли dealer). Возвращает структуру объявления или fallback.
5. **Веб-интерфейс**
   - Страница `/listings/create-from-auction` с формой ввода URL, AJAX-запросом,
     обработкой успешно/ошибочно, предзаполнением полей.
   - Частичное обновление `resources/views/listings/create.blade.php` —
     добавлены блоки для предпросмотра фото и передачи конфигурации формы.
6. **Документация**
   - `STATUS_TZ_v2.1.md`, `PROGRESS_REPORT.md`, `TESTING_GUIDE.md` отражают
     текущий функционал и сценарии проверки.

## 3. Известные отклонения от исходного ТЗ v2.0
- **База данных:** исходное ТЗ требовало MySQL, но фактическая конфигурация
  закреплена на SQLite. На текущем этапе это принятое решение, MySQL оставлен
  как опциональный сервис Sail.
- **Форма создания объявления:** логика переключения секций и сохранения
  `vehicle_details` частично реализована, требуется довести (см. раздел 4).
- **Публичное отображение объявлений:** шаблон `listings/show` пока не выводит
  расширенные данные автомобиля и ссылку на аукцион.
- **Meilisearch:** индекс не обновлён дополнительными полями из
  `vehicle_details`.
- **Остальной объём v2.0 (мобильные приложения, расширенный поиск,
  кастомные поля категорий, модерация, DevOps-чанк)** на текущем этапе не
  реализован и требует переоценки сроков в отдельном плане работ.

## 4. Осталось реализовать в рамках цели v2.1
1. **Форма `listings/create`**
   - Показ и валидация полей `vehicle_details` по условию `listing_type`.
   - Автозаполнение данными из парсера (использовать `listingFormConfig`).
2. **`ListingController@store`**
   - Сохранение `vehicle_details` и флага `is_from_auction`.
   - Обработка массива `auction_photos`: загрузка/прикрепление к медиа.
3. **`listings/show`**
   - Вывод характеристик автомобиля, кнопка «Смотреть на аукционе»
     (если `vehicle_details.is_from_auction = 1`).
4. **Meilisearch/поиск**
   - Добавить фильтры по полям авто, переиндексировать `Listing`.
5. **Тестовые данные**
   - Сидеры или фабрики с примерами `vehicle`-объявлений.
6. **Инфраструктура**
   - Причесать `.env` (актуальные `APP_URL/APP_PORT`, очистка неиспользуемых
     переменных MySQL) и документировать выбор SQLite как основной БД.

## 5. Рекомендации по обновлению ТЗ
- Зафиксировать в официальной версии v2.1 текущее деление объявлений (`vehicle`,
  `parts`) и структуру `vehicle_details`.
- Уточнить порядок работы сценария «быстрое объявление с аукциона» на основе
  реализованных шагов (см. раздел 2).
- Вынести в отдельный backlog крупные блоки из v2.0, которые пока не
  затрагиваются (мобильные приложения, кастомные поля, модерация, аналитика),
  чтобы текущая версия ТЗ не вводила команду в заблуждение.

Документ можно использовать как актуальный baseline для следующего спринта:
пункты из раздела 4 образуют список задач для доведения функционала до MVP.
